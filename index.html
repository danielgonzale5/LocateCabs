<!DOCTYPE html>

<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>LocateCabs Página Principal</title>
  <link rel="icon" href="/favicon.ico"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin="">
    </script>
</head>
<style>
  *{
    padding: 0;
    margin: 0;
    text-decoration: none;
    list-style: none;
    box-sizing: border-box;
  }
  h1:hover{
    cursor: default;
  }
  h2:hover{
    cursor: default;
  }
  body{
    font-family: sans-serif;
    background-image: url('/bg.png');
    height: 100%;
    margin: 0;
    padding: 0;
  }
  label {
    margin:5px;
    font-size: 120%;
    display: inline-block;
  }

  button {
    background-color: #F4D03F;
    border: none;
    color: black;
    padding: 12px 29px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 100%;
  }
  button:hover {
    background-color: #F4D03F;
  }
  button:active {
    background-color: #F4D03F;
    /* box-shadow: 0 5px #666; */
    transform: translateY(4px);
  }
  nav{
    background: rgba(255, 212, 20, 0.8);
    height: 80px;
    width: 100%;
  }
  .padre{
    position: relative;
  }
  .cabecera{
    position: relative;
    z-index: 2;
  }
  .logo{
    display: inline-block;
    margin-top: 2px;
    padding: 0 40px;
  }
  #logoimg{
      height: 70px;
      width: 380px;
  }
  nav ul{
    float: right;
    margin-right: 20px;
  }
  nav ul li{
    display: inline-block;
    line-height: 80px;
  }
  nav ul li a{
    color: rgb(17, 17, 17);
    font-size: 17px;
    font-weight: bold;
    padding: 30px 13px; 
    text-transform: uppercase;
  }
  a.menulink.active,a.menulink:hover{
    background: rgb(19, 19, 19); 
    color: rgb(255, 255, 255);
    transition: .2s;
    border-bottom:4px solid rgb(0, 130, 230);
  }
  .checkbtn{
    font-size: 30px;
    color: rgb(15, 15, 15);
    float: left;
    line-height: 80px;
    margin-left: 15px;
    cursor: pointer;
    display: none;
  }
  #check{
    display: none;
  }
  #mapid {
    margin: 5px;
    height: 650px;
    width: 60%;
    float: left;
    border: 5px solid rgb(12, 12, 12);
    border-radius: 15px;
  }
  #container {
    background-color: rgba(255, 212, 20, .8);
    margin: 1px;
    height: 650px;
    width: auto;
    border: 5px solid rgba(12, 12, 12, .8);
    border-radius: 15px;
    overflow: hidden;
  }
  .inlineclass {
    display: inline-block;
  }
  .CenterButton {
    width: 200;
    padding: 5px 50px 5px 5px;
  }
  .sw {
    display: inline-block;
    width: 100px;
    height: 35px;
    background: rgb(19, 19, 19);
    border-radius: 100px;
    cursor: pointer;
    position: relative;
    transition: 1.2s;
  }
  .sw::after {
    content: "";
    display: block;
    width: 25px;
    height: 25px;
    background-color: snow;
    border-radius: 100px;
    position: absolute;
    top: 5px;
    left: 4px;
    transition: .2s;
  }
  .CB{
    border: 3px solid black; 
    border-radius: 8px; 
    width: 250px; 
    background-color: rgb(14, 14, 14); 
    color:rgb(255, 255, 255); 
    font-weight: bold;

  }
  .CB:hover{
    cursor: pointer;
    border-color: rgb(255, 255, 255);
    color:rgb(14, 14, 14);
    background-color: rgb(255, 255, 255);
    transition: .5s;
    opacity: 0.8;
  }
  .CB:active{
    transform: translateY(24px);
  }
  #switch:checked+.sw::after {
    left: 70px;
  }
  #switch:checked+.sw {
    left: 0px;
    background-color: rgb(184, 194, 42);
  }
  #switch {
    display: none;
    transition: 1.5s;
  }
  #switch2:checked+.sw::after {
    left: 70px;
  }
  #switch2:checked+.sw {
    left: 0px;
    background-color: rgb(184, 194, 42);
  }
  #switch2 {
    display: none;
  }
  #switch3:checked+.sw::after {
    left: 70px;
  }
  #switch3:checked+.sw {
    left: 0px;
    background-color: rgb(184, 194, 42);
  }
  #switch3 {
    display: none;
  }
  .wrapper {
    display: flex;
    width: 100%;
    align-items: center;
    justify-content: center;
    float: center;
    margin-top: 5%;
    position: relative;
    z-index: 1;
  }
  @media (max-width: 860px){
    .logo{
      margin-top: 20px;
      padding-left: 5px;
    }
    #logoimg{
      height: 50px;
      width: 210px;
    }
    .wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }
    #mapid {
      height: 300px;
      width: 90%;
      border-radius: 15px;

    }
    #container {
      height: auto;
      width: 90%;
      
    }
    .checkbtn{
      display: block;
    }
    ul{
      position: absolute;
      width: 65%;
      height: auto;
      background: rgba(58, 58, 58, 0.9);
      top: 80px;
      left: -100%;
      text-align: center;
      transition: all .5s;
    }
    nav ul li{
      display: block;
      margin: 65px 0;
      line-height: 30px;
    }
    nav ul li a{
      font-size: 20px;
    }
    a.menulink:hover,a.menulink.active{
      background: none;
      color: rgb(0, 130, 230);
    }
    #check:checked ~ ul{
      left: 0;
    }
  }
  @media (max-width: 300px){
    #logoimg{
      height: 50px;
      width: 20vh;

    }

  }
  @media (max-width: 267px){
    #logoimg{
      display: none;

    }
    
  }
  section{
    background: url(bg1.jpg) no-repeat;
    background-size: cover;
    height: calc(100vh - 80px);
  }

  footer{
    position: relative;
    background:rgba(17, 17, 17, 0.9);
    height: auto;
    width: 100%;
    bottom: 0px;
    font-family: "Open Sans";
    color:rgb(255, 255, 255);
    z-index: 1;
  }
  .footer-content{
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
  }
  .footer-content h3{
    font-size: 1.8rem;
    font-weight: 400;
    text-transform: capitalize;
    line-height: 3rem;
  }
  .footer-content p{
    margin: 2px auto;
    line-height: 28px;
    font-size: 14px;
  }
  .footer-bottom{
    background: rgba(17, 17, 17, 0.96);
    width: 100%;
    padding: 5px 0;
    text-align: center;
  }
  .footer-bottom span{
    color:rgba(255, 212, 20);
    text-transform: uppercase;
    font-weight: 200;
  }
</style>
<body>
  <div class="padre">
    <div class="cabecera">
      <nav>
        <input type="checkbox" id="check">
        <label for="check" class="checkbtn">
          <i class="fas fa-bars"></i>
        </label>
        <a href="/" class="logo"><img src="/logo.png" id="logoimg" /></a>
        <ul>
            <li><a class="menulink" style="background: rgb(19, 19, 19); color: rgb(255, 255, 255); border-bottom:4px solid rgb(0, 130, 230);">Home</a></li>
            <li><a class="menulink" href="../historicos/">Históricos</a></li>
        </ul>
      </nav>
    </div>
    <div class="wrapper">
      <div class="inlineclass" id="mapid"></div>
      <div class="inlineclass" style="text-align: center;" id="container">
        <h1 style="text-align: center; padding-top: 15px;">INFORMACIÓN DEL TAXI</h1>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">Usuario</label>
        <label class="inlineclass" id="UsuID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">Latitud</label>
        <label class="inlineclass" id="LatID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">Longitud</label>
        <label class="inlineclass" id="LongID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">Fecha</label>
        <label class="inlineclass" id="FechaID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">Hora</label>
        <label class="inlineclass" id="HoraID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <label class="inlineclass" style="width: 100px; padding-left: 10px;">RPM</label>
        <label class="inlineclass" id="RPMID" style="text-align: center; border: 1px solid black; border-radius: 8px; width: 300px; background-color: white;">-</label>
        <div></div>
        <h2 style="text-align: center; margin-top: 15px;">Rastrear ID específica</h2>
        <h4 style="text-align: center; margin-top: 15px; cursor: default;">Seleccione la ID del Taxi para ver su información</h4>

        <select name="cars" id="IDtxtID" onchange="selectedChanged()" style="margin-top: 10px; text-align: center; border-radius: 8px; font-size: 100%;">
          <option value="all">Todas las ID's</option>
        </select>
        <!--<input style="text-align: center; margin-top: 15px;" type="text" id="IDtxtID" name="IDtxt" value="-">-->
        <h2 id="label_recorrido" style="text-align: center; margin-top: 15px; visibility:hidden;">Trazar recorrido</h2>
        <div class="switch-container;" style="text-align: center; margin-top: 5px;">
          <input type="Checkbox" id="switch">
          <label for="switch" class="sw" id="layer_switch" style="visibility:hidden;"></label>
        </div>
      </div>
    </div>
    <footer>
      <div class="footer-content">
        <h3>LocateCABS</h3>
        <p>Repositorio</p>
        <li><a href="https://github.com/danielgonzale5/LocateCabs" target="_blank"><img src="/github.svg" id="gitimg" style="width: 45px;"/></a></li>
        <div class="footer-bottom">
          <p style="font-weight: bold; text-shadow: 2px 2px 8px #ffffff;">Copyright &copy;2021-2022 LocateCABS. designed by: <span>DanielG LeonardoC BozidarY JuanM & JorgeR</span></p>
        </div>
      </div>
    </footer>
  </div>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    //Declaración de Variables Globales
    let lat = 10.984719;
    let long = -74.811302;
    var lat1 = 10.984719;
    var long1 = -74.811302;
    var lat2 = 10.984719;
    var long2 = -74.811302;
    var polyline1;
    var polyline2;
    var polyline_set = 0;
    var startpoint1;
    var startpoint2;
    var latlngs1 = [];
    var latlngsTemp1 = [];
    var latlngs2 = [];
    var latlngsTemp2 = [];
    var usuarios_conectados;
    var Usuarios= new Array();
    var DataObj = new Array();
    var Vehiculos = new Array();
    var first_time = true;
    var circle_markers = new Array();
    var Usuarios_marcados = new Array();
    var dropdownChanged = false;
    var poly_created = false;
    var polylines = new Array();
    var startpoints = new Array();
    var latlongVec = new Array();
    var Usuarios_recorridos = new Array();
    //Serie de funciones para el mapa
    function MapsetUbication() {
      mymap.setView(new L.LatLng(lat, long));
    }
    function setMarker1() {
      if (lat1 != null && isNaN(lat1) == false && long1 != null && isNaN(long1) == false) {
        point1.setLatLng(new L.LatLng(lat1, long1));
      }
    }
    function setMarker2() {
      if (lat2 != null && isNaN(lat2) == false && long2 != null && isNaN(long2) == false) {
        point2.setLatLng(new L.LatLng(lat2, long2));
      }
    }
    function Markerlabel() {
      circle_marker.bindPopup(usuario, { autoPan: false }).openPopup()
    }
    function startPolyline1(ltlgp1) {
      if (isNaN(ltlgp1) == false) {
        polyline1 = L.polyline(ltlgp1).addTo(mymap);
        polyline_set = 1;
      }
    }
    function startPolyline2(ltlgp2) {
      if (isNaN(ltlgp2) == false) {
        polyline2 = L.polyline(ltlgp2).addTo(mymap);
        polyline_set = 1;
      }
    }
    function start2Polyline(ltlgp1, ltlgp2) {
      if (isNaN(ltlgp1) == false && isNaN(ltlgp2) == false) {
        polyline1 = L.polyline(ltlgp1).addTo(mymap);
        polyline2 = L.polyline(ltlgp2).addTo(mymap);
        polyline_set = 1;
      }
    }

    function addPolyline1(ltlgap1) {
      if ((polyline_set == 1)) {
          polyline1.setLatLngs(ltlgap1)
      }
    }

    function addPolyline2(ltlgap2) {
      if ((polyline_set == 1)) {
          polyline2.setLatLngs(ltlgap2)
      }
    }
    function add2Polyline(ltlgap1, ltlgap2) {
      if ((polyline_set == 1)) {
        polyline1.setLatLngs(ltlgap1)
        polyline2.setLatLngs(ltlgap2)
      }
    }
    function clearpoly() {
      if (polyline_set == 1) {
        if (document.getElementById('IDtxtID').value == "1") {
          polyline1.removeFrom(mymap)
        } else if (document.getElementById('IDtxtID').value == "2") {
          polyline2.removeFrom(mymap)
        } else {
          polyline1.removeFrom(mymap)
          polyline2.removeFrom(mymap)
        }
      }
    }

    function selectedChanged(){
      dropdownChanged=true;
    }

    //Esta función genera un color oscuro hexadecimal aleatorio (Esto para el caso de generar múltiples polilíneas y diferenciar cada una)
    function random_hex_color_code(){
      var simbolos, color;
      simbolos = "0123456789ABCDEF";
      colorg = "#55";
      for(var i = 0; i < 4; i++){
        colorg = colorg + simbolos[Math.floor(Math.random() * 16)];
      }
      return colorg;
    }

    function createMarkers(vector_obj){
        vector_obj.forEach(function(obj){
            var color=random_hex_color_code();
            circle_markers.push(L.circleMarker([obj.Latitud, obj.Longitud], { color: color }).bindPopup("ID: " + obj.Usuario, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
            Usuarios_marcados.push(obj.Usuario);
        });

        mymap.setView([vector_obj[vector_obj.length-1].Latitud, vector_obj[vector_obj.length-1].Longitud]);
        
    }

    //Función para buscar el atributo "Usuario" dentro de un array.
    function containsID(array, attribute){ 

        var found = false;
        for(var i = 0; i < array.length; i++) {
            if (array[i].Usuario == attribute) {
                found = true;
                var pos=i;
                break;
            }
        }

        return [pos,found];

    }

    function updateMarkers(vector_obj){
        vector_obj.forEach(function(obj){
            if (Usuarios_marcados.includes(obj.Usuario)){
                let posicion=Usuarios_marcados.indexOf(obj.Usuario);
                circle_markers[posicion].setLatLng(new L.LatLng(obj.Latitud, obj.Longitud));
            } else{
                var color=random_hex_color_code();
                circle_markers.push(L.circleMarker([obj.Latitud, obj.Longitud], { color: color }).bindPopup("ID: " + obj.Usuario, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
                mymap.setView([obj.Latitud, obj.Longitud]);
                Usuarios_marcados.push(obj.Usuario);
                       
                //Vector de orden global: "Usuarios" [1,2,3,4,5...]
                //Vector de lista: "lista_select.options" [all, 1, 5, 7]
                //Num que se agregará: "obj.Usuario"

                var lista_select = document.getElementById('IDtxtID');
                var new_opt = document.createElement('option');
                new_opt.value = obj.Usuario;
                new_opt.innerHTML = obj.Usuario;
                //var vector_lista = new Array();
                var posiciones_lista = new Array();
                //var posiciones_lista_ordenado = new Array();
                let posicion_usuario_nuevo= Usuarios.indexOf(obj.Usuario);
                var index = 1;
                var menor_a_todos=true;
                var mayor_a_todos=false;

                for (var i=1; i<lista_select.length; i++){

                  posiciones_lista.push(Usuarios.indexOf(lista_select.options[i].value));

                }

                for (var j=0; j<posiciones_lista.length; j++){
                  if(posicion_usuario_nuevo > posiciones_lista[j]){                                      
                    if (posicion_usuario_nuevo > posiciones_lista[posiciones_lista.length - 1]){
                      mayor_a_todos=true;
                    } else{
                      for(var k=j; k<posiciones_lista.length; k++){
                        if (posicion_usuario_nuevo < posiciones_lista[k]){
                          index = k + 1;
                          break;
                        }
                      }
                    }
                    menor_a_todos=false;
                    break;
                  }
                }

                if (!menor_a_todos){
                  if (!mayor_a_todos){
                    lista_select.insertBefore(new_opt, lista_select.options[index]);
                  } else{
                    lista_select.appendChild(new_opt)
                  }
                  
                }else{

                  lista_select.insertBefore(new_opt, lista_select.options[index]);

                }

            }
        });

        //(Opcional) Desaparición del marcador, si el vehículo ya no aparece en el vector "Vehiculos".
        Usuarios_marcados.forEach(function(user){
            [pos, found] = containsID(vector_obj, user);
            if (!found){
                let posicion_d = Usuarios_marcados.indexOf(user);
                let marker_removed = circle_markers[posicion_d];
                mymap.removeLayer(marker_removed);
                circle_markers.splice(posicion_d, 1);
                Usuarios_marcados.splice(posicion_d, 1);

                var lista_select = document.getElementById('IDtxtID');

                for (var i=1; i<lista_select.length; i++){
                  if (lista_select.options[i].value==user){
                    lista_select.removeChild(lista_select.options[i]);
                  }
                }

            }
        });

    }

    function startPolyline(selected_value){

      if (selected_value=='all'){

        var lista_select = document.getElementById('IDtxtID');
        for (var i=1; i<lista_select.length; i++){
          var [pos, found] = containsID(Vehiculos, lista_select.options[i].value);
          var latlng= new Array(Vehiculos[pos].Latitud, Vehiculos[pos].Longitud);
          polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
          startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + lista_select.options[i].value, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
          latlongVec.push(new Array(latlng));
          Usuarios_recorridos.push(lista_select.options[i].value);
          console.log('Longitud vector de vector de vectores: ' + latlongVec.length)
        }

      } else{
        startpoints=[];
        var [pos, found] = containsID(Vehiculos, selected_value);
        var latlng= new Array(Vehiculos[pos].Latitud, Vehiculos[pos].Longitud);
        polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
        startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + selected_value, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
        latlongVec.push(new Array(latlng));
        Usuarios_recorridos.push(selected_value);
      }

      poly_created=true;

    }


    function updatePolyline(selected_value){

      console.log('Actualizando polilíneas...')

      //Elimina las polilíneas de las ID's que se borraron en el mapa.
      var lista_select = document.getElementById('IDtxtID');
      var lista_vec = new Array();
      var datos_para_eliminar = new Array();
      for (var i=1; i<lista_select.length; i++){
        lista_vec.push(lista_select.options[i].value);
      }

      Usuarios_recorridos.forEach((element) => {
        if(!lista_vec.includes(element)){
          datos_para_eliminar.push(element);
        }
      });

      if (datos_para_eliminar.length!=0){

        datos_para_eliminar.forEach((dato) =>{

        if (Usuarios_recorridos.includes(dato)){

          posicion_dato=Usuarios_recorridos.indexOf(dato);
          var polyline_removed = polylines[posicion_dato];
          var startpoint_removed = startpoints[posicion_dato];
          mymap.removeLayer(polyline_removed);
          mymap.removeLayer(startpoint_removed);
          polylines.splice(posicion_dato, 1);
          startpoints.splice(posicion_dato, 1);
          Usuarios_recorridos.splice(posicion_dato, 1);
          latlongVec.splice(posicion_dato, 1);
        }

        });

      }
      
      //Agrega las polilíneas de las ID's que aparezcan "de casualidad" en el mapa.
      var datos_para_agregar = new Array();

      if (selected_value=='all'){

        lista_vec.forEach((element) =>{
          if(!Usuarios_recorridos.includes(element)){
            datos_para_agregar.push(element);
          }       
        });

      } else{

        if(!Usuarios_recorridos.includes(selected_value)){
            datos_para_agregar.push(selected_value);
        }   

      }
      

      if (datos_para_agregar.length!=0){
        datos_para_agregar.forEach((dato) =>{
          if (!Usuarios_recorridos.includes(dato)){
            var [posn, found] = containsID(Vehiculos, dato);
            var latlng= new Array(Vehiculos[posn].Latitud, Vehiculos[posn].Longitud);
            polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
            startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + dato, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());                 
            latlongVec.push(new Array(latlng));
            Usuarios_recorridos.push(dato);
          }    
          
          

        });
      }

      if (selected_value=='all'){
        console.log('Se seleccionó todos')
        for(var i=0; i<polylines.length; i++){
          var attr=Usuarios_recorridos[i];
          var [pos_latlong, found] = containsID(Vehiculos, attr);
          var latlngTemp = new Array(Vehiculos[pos_latlong].Latitud, Vehiculos[pos_latlong].Longitud);
          latlongVec[i].push(latlngTemp);
          polylines[i].setLatLngs(latlongVec[i]);
        }


      } else{
        console.log('Se seleccionó ' + selected_value);
        var [pos_latlongx, foundx] = containsID(Vehiculos, selected_value);
        var latlngTemp = new Array(Vehiculos[pos_latlongx].Latitud, Vehiculos[pos_latlongx].Longitud);
        latlongVec[0].push(latlngTemp);
        polylines[0].setLatLngs(latlongVec[0]);

      }

    }

    function clearMarkers(){
      circle_markers.forEach(function (item){   
        mymap.removeLayer(item);
      })
      circle_markers=[];
      Usuarios_marcados=[];
    }

    function clearPolylines(){
      polylines.forEach(function(item){
        mymap.removeLayer(item);
      });
      startpoints.forEach(function(item){
        mymap.removeLayer(item);
      });
      polylines=[];
      startpoints=[];
      Usuarios_recorridos=[];
      latlongVec=[];
      poly_created=false;
    }

    let mymap = L.map('mapid').setView([lat, long], 14);
    //var point1 = L.marker([lat1, long1]).bindPopup("ID Usuario: 1", { autoPan: false }).addTo(mymap);
    //var point2 = L.marker([lat2, long2]).bindPopup("ID Usuario: 2", { autoPan: false }).addTo(mymap);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(mymap);

    //Este socket recibe el vector de usuarios de la base de datos vistos por primera vez cuando se conecta el cliente a la página.
    io().on('init_users', function (users){
      Userv= users.Usersvec;
      //console.log(Userv);
      //var lista_select = document.getElementById('IDtxtID');
      for (var i = 0; i<Userv.length; i++){
        if (Userv[i]!='' && Userv[i]!='-'){
          Usuarios.push(Userv[i]);
          //var new_opt = document.createElement('option');
          //new_opt.value = Userv[i];
          //new_opt.innerHTML = Userv[i];
          //lista_select.appendChild(new_opt);
        }
      } 

      Usuarios=Usuarios.sort(function(a, b){
        return a-b
      });
      console.log(Usuarios);
    });
    
    //Este socket, a diferencia del anterior, detecta si hay un usuario nuevo en la base de datos y lo agrega a la lista desplegable. Esto es para que el cliente no se vea obligado a recargar la página.
    io().on('new_user_detected', function(user){
      usuario_detectado=user.Newuser;
      Usuarios.push(usuario_detectado);
      Usuarios=Usuarios.sort(function(a, b){
        return a-b
      });
      console.log(Usuarios)
      //var lista_select = document.getElementById('IDtxtID');
      //var new_opt = document.createElement('option');
      //new_opt.value = usuario_detectado;
      //new_opt.innerHTML = usuario_detectado;
      //lista_select.appendChild(new_opt);
      
    })

    //Este socket detecta los usuarios conectados o que se encuentran enviando información desde el Backend.
    io().on('connectedusers', (usuarios_analizados) =>{
        usuarios_conectados=usuarios_analizados.Cantidad;
    });

    //Recepción y traducción de información del Backend
    document.addEventListener('DOMContentLoaded', function () {
        //Este socket recibe el vector de objetos o vehículos con sus atributos de latitud, longitud, tiempo y RPM, enviado desde el Backend.
        io().on('change', function(data){
            
            if (data.GPSobj.length==usuarios_conectados){
                Vehiculos=[];
                console.log('Información recibida!');
                console.log('Cantidad de usuarios conectados: ' + data.GPSobj.length);
                DataObj = data.GPSobj;
                DataObj.forEach(function (obj){
                    var date = new Date(parseFloat(obj.DataTime));
                    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    var month = months[date.getMonth()];
                    var hours = date.toLocaleTimeString();
                    var minutes = "0" + date.getMinutes();
                    var seconds = "0" + date.getSeconds();
                    var formattedTime = hours.substr(0, 2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                    var datofecha = date.getDate() + "/" + month + "/" + date.getFullYear();
                    
                    Vehiculos.push(new Object({
                        Usuario: obj.DataUsu,
                        Latitud: obj.DataLat,
                        Longitud: obj.DataLong,
                        Fecha: datofecha,
                        Hora: formattedTime,
                        RPM: obj.DataRPM
                    }));
                });

                if (first_time){
                    createMarkers(Vehiculos);
                    Usuarios.forEach( (user) => {
                      var lista_select = document.getElementById('IDtxtID');
                      if (Usuarios_marcados.includes(user)){ 
                        var new_opt = document.createElement('option');
                        new_opt.value = user;
                        new_opt.innerHTML = user;
                        lista_select.appendChild(new_opt);
                      }
                    });                           
                    first_time=false;
                } else{
                    updateMarkers(Vehiculos);                    
                }

                var label= document.getElementById('label_recorrido');
                var sw= document.getElementById('layer_switch');
                var lista_select = document.getElementById('IDtxtID');
                var selected_value = lista_select.options[lista_select.selectedIndex].value;

                label.style.visibility="visible"; sw.style.visibility="visible";
                if (dropdownChanged && poly_created){
                  clearPolylines();
                  dropdownChanged=false;
                }

                if (selected_value=='all'){

                  document.getElementById('UsuID').innerHTML = '-';
                  document.getElementById('LatID').innerHTML = '-';
                  document.getElementById('LongID').innerHTML = '-';
                  document.getElementById('FechaID').innerHTML = '-';
                  document.getElementById('HoraID').innerHTML = '-';
                  document.getElementById('RPMID').innerHTML = '-';

                } else{

                  [pos, found] = containsID(Vehiculos, selected_value);
                  document.getElementById('UsuID').innerHTML = Vehiculos[pos].Usuario;
                  document.getElementById('LatID').innerHTML = Vehiculos[pos].Latitud;
                  document.getElementById('LongID').innerHTML = Vehiculos[pos].Longitud;
                  document.getElementById('FechaID').innerHTML = Vehiculos[pos].Fecha;
                  document.getElementById('HoraID').innerHTML = Vehiculos[pos].Hora;
                  document.getElementById('RPMID').innerHTML = Vehiculos[pos].RPM;

                }

                var valor = document.getElementById('switch').checked;

                if (valor){
                  if (!poly_created){
                    startPolyline(selected_value);
                  }else{
                    updatePolyline(selected_value);
                  }
                } else{
                  if (poly_created){
                    clearPolylines();
                  }
                }
            }
        });

        //Este socket detecta si no hay ningún usuario conectado en el mapa.
        io().on('nousersconnected', function(){
            clearMarkers(); clearPolylines();
            var label= document.getElementById('label_recorrido');
            var sw= document.getElementById('layer_switch');
            var lista_select = document.getElementById("IDtxtID");

            if (lista_select.length>1){
              let loops=lista_select.length;
              for (var i=0; i<loops; i++) {
                lista_select.remove(1);      
              }
            }
            document.getElementById('switch').checked=false;
            label.style.visibility="hidden"; sw.style.visibility="hidden";

            document.getElementById('UsuID').innerHTML = '-';
            document.getElementById('LatID').innerHTML = '-';
            document.getElementById('LongID').innerHTML = '-';
            document.getElementById('FechaID').innerHTML = '-';
            document.getElementById('HoraID').innerHTML = '-';
            document.getElementById('RPMID').innerHTML = '-';

            console.log('NO HAY USUARIOS CONECTADOS! ADONDEFUERON?');
        });


      io().on('change1', function (data) {
        document.getElementById('UsuID').innerHTML = data.DataUsu;
        document.getElementById('LatID').innerHTML = data.DataLat;
        document.getElementById('LongID').innerHTML = data.DataLong;
        document.getElementById('RPMID').innerHTML = data.DataRPM;
        var date = new Date(parseFloat(data.DataTime));
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var month = months[date.getMonth()];
        var hours = date.toLocaleTimeString();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = hours.substr(0, 2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        var datofecha = date.getDate() + "/" + month + "/" + date.getFullYear();
        document.getElementById('FechaID').innerHTML = datofecha;
        document.getElementById('HoraID').innerHTML = formattedTime;
        var TaxID = document.getElementById('IDtxtID').innerHTML;
        lat1 = data.DataLat;
        long1 = data.DataLong;
        usuario = data.DataUsu;
        setInterval(setMarker1, 1000);
        valor = document.getElementById('switch').checked;
        if (valor) {
            if (document.getElementById('IDtxtID').value == "1") {
                if(latlngs1.length != 1) {
                setInterval(latlngsTemp1 = [lat1, long1], 1000);
                setInterval(latlngs1.push(latlngsTemp1), 1000);
            } else {
                startpoint1 = L.marker(latlngs1[0]).bindPopup("Inicio ID: 1", { autoPan: false }).addTo(mymap);
                setInterval(latlngsTemp1 = [lat1, long1], 1000);
                setInterval(latlngs1.push(latlngsTemp1), 1000);
            }
            } else if (document.getElementById('IDtxtID').value == "2") {

            } else {
                if(latlngs1.length != 1) {
                setInterval(latlngsTemp1 = [lat1, long1], 1000);
                setInterval(latlngs1.push(latlngsTemp1), 1000);
            } else {
                startpoint1 = L.marker(latlngs1[0]).bindPopup("Inicio ID: 1", { autoPan: false }).addTo(mymap);
                setInterval(latlngsTemp1 = [lat1, long1], 1000);
                setInterval(latlngs1.push(latlngsTemp1), 1000);
            }
            }
        } else {
          latlngs1 = [];
        }
      });
      io().on('change2', function (data) {
        document.getElementById('UsuID').innerHTML = data.DataUsu;
        document.getElementById('LatID').innerHTML = data.DataLat;
        document.getElementById('LongID').innerHTML = data.DataLong;
        document.getElementById('RPMID').innerHTML = data.DataRPM;
        var date = new Date(parseFloat(data.DataTime));
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var month = months[date.getMonth()];
        var hours = date.toLocaleTimeString();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = hours.substr(0, 2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
        var datofecha = date.getDate() + "/" + month + "/" + date.getFullYear();
        document.getElementById('FechaID').innerHTML = datofecha;
        document.getElementById('HoraID').innerHTML = formattedTime;
        var TaxID = document.getElementById('IDtxtID').innerHTML;
        lat2 = data.DataLat;
        long2 = data.DataLong;
        usuario = data.DataUsu;
        setInterval(setMarker2, 1000);
        valor = document.getElementById('switch').checked;
        if (valor) {
            if (document.getElementById('IDtxtID').value == "1") {

            } else if (document.getElementById('IDtxtID').value == "2") {
                if(latlngs2.length != 1) {
                    setInterval(latlngsTemp2 = [lat2, long2], 1000);
                    setInterval(latlngs2.push(latlngsTemp2), 1000);
                } else {
                    startpoint2 = L.marker(latlngs2[0]).bindPopup("Inicio ID: 2", { autoPan: false }).addTo(mymap);
                    setInterval(latlngsTemp2 = [lat2, long2], 1000);
                    setInterval(latlngs2.push(latlngsTemp2), 1000);
                }
            } else {
                if(latlngs2.length != 1) {
                    setInterval(latlngsTemp2 = [lat2, long2], 1000);
                    setInterval(latlngs2.push(latlngsTemp2), 1000);
                } else {
                    startpoint2 = L.marker(latlngs2[0]).bindPopup("Inicio ID: 2", { autoPan: false }).addTo(mymap);
                    setInterval(latlngsTemp2 = [lat2, long2], 1000);
                    setInterval(latlngs2.push(latlngsTemp2), 1000);
                }
            }
        } else {
          latlngs2 = [];
        }
      });
    });
    function condicional() {
        valor = document.getElementById('switch').checked;
        if (valor) {
          setTimeout(function () {
            clearpoly();
            startpoint1.removeFrom(mymap);
            startpoint2.removeFrom(mymap);
          }, 200)
        } else {
          if (document.getElementById('IDtxtID').value == "1") {
            console.log('latlngs1=' + latlngs1.length)
            setInterval(function () {
              addPolyline1(latlngs1);
            }, 200); 
            setTimeout(function () {
              startPolyline1(latlngs1);
            }, 200);
          } else if (document.getElementById('IDtxtID').value == "2") {
            console.log('latlngs2=' + latlngs2.length)
            setInterval(function () {
              addPolyline2(latlngs2);
            }, 200);
            setTimeout(function () {
              startPolyline2(latlngs2);
            }, 200);
          } else {
            console.log('latlngs1=' + latlngs1.length)
            console.log('latlngs2=' + latlngs2.length)
            setInterval(function () {
              add2Polyline(latlngs1, latlngs2);
            }, 200);
            setTimeout(function () {
              start2Polyline(latlngs1, latlngs2);
            }, 200);
          }
        }
    }
  </script>
</body>

</html>