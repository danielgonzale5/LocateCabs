<!DOCTYPE html>

<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>LocateCabs Página Principal</title>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/idxstyle.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin="">
  </script>
  <link rel="stylesheet preload prefetch" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" type="text/css" as="style">
</head>
<body> 
  
  <input type="checkbox" id="btn-menu">
  <div id="aa-wp">
    <header id="header" class="primary-bg por z3">
      <div class="cont dfx aiec">  
        <figure class="logo pdy1 pdr1 por dfx aiec sm-mar1">
          <label for="btn-menu" class="btn btn-menu btn-lg secondary-bg mar1 z2">
            <i class="menu-icon" aria-hidden="true">menu</i>
          </label>    
          <a><img src="/logo.svg" id="logoimg" /></a>    
        </figure>

        <nav  class="menu-a">
          <ul>
            <button class="btn" onclick="downloadApk()"><img src="/download.svg#Layer_1" class="filter-yellow" style="height: 2rem; "></img>Descargar <span>Apk</span></button>
          </ul>
        </nav>

        <nav class="menu white-bg pdy2 z3" id="navbar">
          <label for="btn-menu" class="btn btn-link btn-closeMenu sec-co fz5">
            <img src="/times.svg#Layer_1" class="filter-red"></img>
          </label>
          <p class="ttu fwb fz3 mab2 pdx3 pdt1 primary-co">Servicios</p>
          <ul class="pdb3 mab3">
            <li class="fa-svg" id="current-pageli">
              <a aria-label="Geolocalization">
                <svg class="ic">
                   <use href="/gps.svg#Layer_1" class="filter-green"></use>
                </svg>
                Geolocalización
              </a>
  
            </li>
            <li class="fa-svg">
              <a aria-label="Historial" class="page-link" href="/historicos">
                <svg class="ic" style="margin-left: .3rem">
                   <use href="/historico.svg#Layer_1" class="filter-green"></use>
                </svg>
                Históricos
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </header>
    <div class="connect" style="pointer-events: none;">
      <span style="color: rgb(253, 237, 6)">Taxis </span> <span style="color: rgb(255, 255, 255)">conectados: </span>  <span style="font-weight: bold; color: rgb(214, 0, 71);" id="usersnumber">0</span>
    </div>
    <div class="wrapper">

      <div class="inlineclass" id="mapid"></div>

      <div class="inlineclass" style="text-align: center;" id="container">

        <div class="selection">
          <h4 style="text-align: center; margin-top: 15px; cursor: default;">Seleccione la ID del Taxi:</h4>
          <select name="cars" id="IDtxtID" onchange="selectedChanged()" style="justify-content: center; text-align: center; border-radius: 2px;">
            <option value="all">Todas las ID's</option>
          </select>
          <h4 id="label_recorrido" style="text-align: center; margin-top: 15px; visibility:hidden;">Trazar recorrido</h2>
          <div class="switch-container;" style="text-align: center; margin-top: 5px;">
            <input type="Checkbox" id="switch">
            <label for="switch" class="sw" id="layer_switch" style="visibility:hidden;"></label>
          </div>
        </div>
        
        <div class="menu-par">
          <div class="menu-div">
          <label class="txt-label">Usuario</label>
          <label class="txt-box" id="UsuID"></label>
          </div>
          <div class="menu-div">
          <label class="txt-label">Latitud</label>
          <label class="txt-box" id="LatID"></label>
          </div>
          <div class="menu-div">
          <label class="txt-label">Longitud</label>
          <label class="txt-box" id="LongID"></label>
          </div>
          <div class="menu-div">
          <label class="txt-label">Fecha</label>
          <label class="txt-box" id="FechaID"></label>
          </div>
          <div class="menu-div">
          <label class="txt-label">Hora</label>
          <label class="txt-box" id="HoraID"></label>
          </div>
          <div class="menu-div">
          <label class="txt-label">RPM</label>
          <label class="txt-box" id="RPMID"></label>
          </div>
        </div>
      </div>  
    </div>
  </div>
   <footer>
      <div class="footer-content">
        <p>Visita nuestro Repositorio <img src="/heart.svg#Layer_1" class="filter-redv" style="display: inline-block; height: 1.25rem;"></img> : </p>
        <li><a href="https://github.com/danielgonzale5/LocateCabs" target="_blank"><img src="/github.svg" id="gitimg" style="width: 45px;"/></a></li>
        <div class="footer-bottom">
          <p style="font-weight: bold; text-shadow: 2px 2px 8px #ffffff;">Copyright &copy;2021-2022 LocateCABS. Designed by: <span>DanielG LeonardoC BozidarY JuanM & JorgeR</span></p>
        </div>
      </div>
    </footer>
  <script src="/socket.io/socket.io.js"></script>
  <script>

    //Descarga la Apk
    function downloadApk(){
      var a = document.createElement("a");
      a.href = "/app-release.apk";
      a.setAttribute("download", "app-release.apk");
      a.click();
      a.remove();
    }


    //Declaración de Variables Globales
    let lat = 10.984719;
    let long = -74.811302;
    var usuarios_conectados;
    var Usuarios= new Array();
    var DataObj = new Array();
    var Vehiculos = new Array();
    var first_time = true;
    var circle_markers = new Array();
    var Usuarios_marcados = new Array();
    var dropdownChanged = false;
    var poly_created = false;
    var polylines = new Array();
    var startpoints = new Array();
    var latlongVec = new Array();
    var Usuarios_recorridos = new Array();

    let mode_pin = false;
    var pin_set = false;
    var pin;
    let mymap = L.map('mapid').setView([lat, long], 14);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(mymap);

    var popup = L.popup();

    function onMapClick(e) {
        if (mode_pin){
          if (pin_set){
          mymap.removeLayer(pin);
          pin_set=false;
          }
          pin=L
            .circle(e.latlng,{radius: 500,color: '#E70042'})
            .addTo(mymap);
          pin_set=true;
        }
    }

    mymap.on('click', onMapClick);


    //Serie de funciones para el mapa
    function selectedChanged(){
      dropdownChanged=true;
    }

    //Esta función genera un color oscuro hexadecimal aleatorio (Esto para el caso de generar múltiples polilíneas y diferenciar cada una)
    function random_hex_color_code(){
      var simbolos, color;
      simbolos = "0123456789ABCDEF";
      colorg = "#55";
      for(var i = 0; i < 4; i++){
        colorg = colorg + simbolos[Math.floor(Math.random() * 16)];
      }
      return colorg;
    }

    function createMarkers(vector_obj){
        vector_obj.forEach(function(obj){
            var color=random_hex_color_code();
            circle_markers.push(L.circleMarker([obj.Latitud, obj.Longitud], { color: color }).bindPopup("ID: " + obj.Usuario, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
            Usuarios_marcados.push(obj.Usuario);
        });

        mymap.setView([vector_obj[vector_obj.length-1].Latitud, vector_obj[vector_obj.length-1].Longitud]);
        
    }

    //Función para buscar el atributo "Usuario" dentro de un array.
    function containsID(array, attribute){ 

        var found = false;
        for(var i = 0; i < array.length; i++) {
            if (array[i].Usuario == attribute) {
                found = true;
                var pos=i;
                break;
            }
        }

        return [pos,found];

    }

    function updateMarkers(vector_obj){
        vector_obj.forEach(function(obj){
            if (Usuarios_marcados.includes(obj.Usuario)){
                let posicion=Usuarios_marcados.indexOf(obj.Usuario);
                circle_markers[posicion].setLatLng(new L.LatLng(obj.Latitud, obj.Longitud));
            } else{
                var color=random_hex_color_code();
                circle_markers.push(L.circleMarker([obj.Latitud, obj.Longitud], { color: color }).bindPopup("ID: " + obj.Usuario, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
                mymap.setView([obj.Latitud, obj.Longitud]);
                Usuarios_marcados.push(obj.Usuario);
                       
                var lista_select = document.getElementById('IDtxtID');
                var new_opt = document.createElement('option');
                new_opt.value = obj.Usuario;
                new_opt.innerHTML = obj.Usuario;
                var posiciones_lista = new Array();
                let posicion_usuario_nuevo= Usuarios.indexOf(obj.Usuario);
                var index = 1;
                var menor_a_todos=true;
                var mayor_a_todos=false;

                for (var i=1; i<lista_select.length; i++){

                  posiciones_lista.push(Usuarios.indexOf(lista_select.options[i].value));

                }

                for (var j=0; j<posiciones_lista.length; j++){
                  if(posicion_usuario_nuevo > posiciones_lista[j]){                                      
                    if (posicion_usuario_nuevo > posiciones_lista[posiciones_lista.length - 1]){
                      mayor_a_todos=true;
                    } else{
                      for(var k=j; k<posiciones_lista.length; k++){
                        if (posicion_usuario_nuevo < posiciones_lista[k]){
                          index = k + 1;
                          break;
                        }
                      }
                    }
                    menor_a_todos=false;
                    break;
                  }
                }

                if (!menor_a_todos){
                  if (!mayor_a_todos){
                    lista_select.insertBefore(new_opt, lista_select.options[index]);
                  } else{
                    lista_select.appendChild(new_opt)
                  }
                  
                }else{

                  lista_select.insertBefore(new_opt, lista_select.options[index]);

                }

            }
        });

        //(Opcional) Desaparición del marcador, si el vehículo ya no aparece en el vector "Vehiculos".
        Usuarios_marcados.forEach(function(user){
            [pos, found] = containsID(vector_obj, user);
            if (!found){
                let posicion_d = Usuarios_marcados.indexOf(user);
                let marker_removed = circle_markers[posicion_d];
                mymap.removeLayer(marker_removed);
                circle_markers.splice(posicion_d, 1);
                Usuarios_marcados.splice(posicion_d, 1);

                var lista_select = document.getElementById('IDtxtID');

                for (var i=1; i<lista_select.length; i++){
                  if (lista_select.options[i].value==user){
                    lista_select.removeChild(lista_select.options[i]);
                  }
                }

            }
        });

    }

    function startPolyline(selected_value){

      if (selected_value=='all'){

        var lista_select = document.getElementById('IDtxtID');
        for (var i=1; i<lista_select.length; i++){
          var [pos, found] = containsID(Vehiculos, lista_select.options[i].value);
          var latlng= new Array(Vehiculos[pos].Latitud, Vehiculos[pos].Longitud);
          polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
          startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + lista_select.options[i].value, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
          latlongVec.push(new Array(latlng));
          Usuarios_recorridos.push(lista_select.options[i].value);
          console.log('Longitud vector de vector de vectores: ' + latlongVec.length)
        }

      } else{
        startpoints=[];
        var [pos, found] = containsID(Vehiculos, selected_value);
        var latlng= new Array(Vehiculos[pos].Latitud, Vehiculos[pos].Longitud);
        polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
        startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + selected_value, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());
        latlongVec.push(new Array(latlng));
        Usuarios_recorridos.push(selected_value);
      }

      poly_created=true;

    }


    function updatePolyline(selected_value){

      console.log('Actualizando polilíneas...')

      //Elimina las polilíneas de las ID's que se borraron en el mapa.
      var lista_select = document.getElementById('IDtxtID');
      var lista_vec = new Array();
      var datos_para_eliminar = new Array();
      for (var i=1; i<lista_select.length; i++){
        lista_vec.push(lista_select.options[i].value);
      }

      Usuarios_recorridos.forEach((element) => {
        if(!lista_vec.includes(element)){
          datos_para_eliminar.push(element);
        }
      });

      if (datos_para_eliminar.length!=0){

        datos_para_eliminar.forEach((dato) =>{

        if (Usuarios_recorridos.includes(dato)){

          posicion_dato=Usuarios_recorridos.indexOf(dato);
          var polyline_removed = polylines[posicion_dato];
          var startpoint_removed = startpoints[posicion_dato];
          mymap.removeLayer(polyline_removed);
          mymap.removeLayer(startpoint_removed);
          polylines.splice(posicion_dato, 1);
          startpoints.splice(posicion_dato, 1);
          Usuarios_recorridos.splice(posicion_dato, 1);
          latlongVec.splice(posicion_dato, 1);
        }

        });

      }
      
      //Agrega las polilíneas de las ID's que aparezcan "de casualidad" en el mapa.
      var datos_para_agregar = new Array();

      if (selected_value=='all'){

        lista_vec.forEach((element) =>{
          if(!Usuarios_recorridos.includes(element)){
            datos_para_agregar.push(element);
          }       
        });

      } else{

        if(!Usuarios_recorridos.includes(selected_value)){
            datos_para_agregar.push(selected_value);
        }   

      }
      

      if (datos_para_agregar.length!=0){
        datos_para_agregar.forEach((dato) =>{
          if (!Usuarios_recorridos.includes(dato)){
            var [posn, found] = containsID(Vehiculos, dato);
            var latlng= new Array(Vehiculos[posn].Latitud, Vehiculos[posn].Longitud);
            polylines.push(L.polyline(new Array(latlng), {color: 'red'}).addTo(mymap));
            startpoints.push(L.marker(latlng).bindPopup("Inicio ID: " + dato, { autoPan: false, autoClose: false }).addTo(mymap).openPopup());                 
            latlongVec.push(new Array(latlng));
            Usuarios_recorridos.push(dato);
          }    
          
          

        });
      }

      if (selected_value=='all'){
        console.log('Se seleccionó todos')
        for(var i=0; i<polylines.length; i++){
          var attr=Usuarios_recorridos[i];
          var [pos_latlong, found] = containsID(Vehiculos, attr);
          var latlngTemp = new Array(Vehiculos[pos_latlong].Latitud, Vehiculos[pos_latlong].Longitud);
          latlongVec[i].push(latlngTemp);
          polylines[i].setLatLngs(latlongVec[i]);
        }


      } else{
        console.log('Se seleccionó ' + selected_value);
        var [pos_latlongx, foundx] = containsID(Vehiculos, selected_value);
        var latlngTemp = new Array(Vehiculos[pos_latlongx].Latitud, Vehiculos[pos_latlongx].Longitud);
        latlongVec[0].push(latlngTemp);
        polylines[0].setLatLngs(latlongVec[0]);

      }

    }

    function clearMarkers(){
      circle_markers.forEach(function (item){   
        mymap.removeLayer(item);
      })
      circle_markers=[];
      Usuarios_marcados=[];
    }

    function clearPolylines(){
      polylines.forEach(function(item){
        mymap.removeLayer(item);
      });
      startpoints.forEach(function(item){
        mymap.removeLayer(item);
      });
      polylines=[];
      startpoints=[];
      Usuarios_recorridos=[];
      latlongVec=[];
      poly_created=false;
    }   

    //Este socket recibe el vector de usuarios de la base de datos vistos por primera vez cuando se conecta el cliente a la página.
    io().on('init_users', function (users){
      Userv= users.Usersvec;
      for (var i = 0; i<Userv.length; i++){
        if (Userv[i]!='' && Userv[i]!='-'){
          Usuarios.push(Userv[i]);
        }
      } 

      Usuarios=Usuarios.sort(function(a, b){
        return a-b
      });
      console.log(Usuarios);
    });
    
    //Este socket, a diferencia del anterior, detecta si hay un usuario nuevo en la base de datos y lo agrega a la lista desplegable. Esto es para que el cliente no se vea obligado a recargar la página.
    io().on('new_user_detected', function(user){
      usuario_detectado=user.Newuser;
      Usuarios.push(usuario_detectado);
      Usuarios=Usuarios.sort(function(a, b){
        return a-b
      });
      console.log(Usuarios)      
    })

    //Este socket detecta los usuarios conectados o que se encuentran enviando información desde el Backend.
    io().on('connectedusers', (usuarios_analizados) =>{
        usuarios_conectados=usuarios_analizados.Cantidad;
    });

    //Recepción y traducción de información del Backend
    document.addEventListener('DOMContentLoaded', function () {
        //Este socket recibe el vector de objetos o vehículos con sus atributos de latitud, longitud, tiempo y RPM, enviado desde el Backend.
        io().on('change', function(data){
            
            if (data.GPSobj.length==usuarios_conectados){
                var number_users = document.getElementById("usersnumber");
                Vehiculos=[];
                console.log('Información recibida!');
                console.log('Cantidad de usuarios conectados: ' + data.GPSobj.length);
                number_users.innerHTML = data.GPSobj.length.toString();
                number_users.style.color='rgb(257, 237, 6)';
                DataObj = data.GPSobj;
                DataObj.forEach(function (obj){
                    var date = new Date(parseFloat(obj.DataTime));
                    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    var month = months[date.getMonth()];
                    var hours = date.toLocaleTimeString();
                    var minutes = "0" + date.getMinutes();
                    var seconds = "0" + date.getSeconds();
                    var formattedTime = hours.substr(0, 2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
                    var datofecha = date.getDate() + "/" + month + "/" + date.getFullYear();
                    
                    Vehiculos.push(new Object({
                        Usuario: obj.DataUsu,
                        Latitud: obj.DataLat,
                        Longitud: obj.DataLong,
                        Fecha: datofecha,
                        Hora: formattedTime,
                        RPM: obj.DataRPM
                    }));
                });

                if (first_time){
                    createMarkers(Vehiculos);
                    Usuarios.forEach( (user) => {
                      var lista_select = document.getElementById('IDtxtID');
                      if (Usuarios_marcados.includes(user)){ 
                        var new_opt = document.createElement('option');
                        new_opt.value = user;
                        new_opt.innerHTML = user;
                        lista_select.appendChild(new_opt);
                      }
                    });                           
                    first_time=false;
                } else{
                    updateMarkers(Vehiculos);                    
                }

                var label= document.getElementById('label_recorrido');
                var sw= document.getElementById('layer_switch');
                var lista_select = document.getElementById('IDtxtID');
                var selected_value = lista_select.options[lista_select.selectedIndex].value;

                label.style.visibility="visible"; sw.style.visibility="visible";
                if (dropdownChanged && poly_created){
                  clearPolylines();
                  dropdownChanged=false;
                }

                if (selected_value=='all'){

                  document.getElementById('UsuID').innerHTML = '-';
                  document.getElementById('LatID').innerHTML = '-';
                  document.getElementById('LongID').innerHTML = '-';
                  document.getElementById('FechaID').innerHTML = '-';
                  document.getElementById('HoraID').innerHTML = '-';
                  document.getElementById('RPMID').innerHTML = '-';

                } else{

                  [pos, found] = containsID(Vehiculos, selected_value);
                  document.getElementById('UsuID').innerHTML = Vehiculos[pos].Usuario;
                  document.getElementById('LatID').innerHTML = Vehiculos[pos].Latitud;
                  document.getElementById('LongID').innerHTML = Vehiculos[pos].Longitud;
                  document.getElementById('FechaID').innerHTML = Vehiculos[pos].Fecha;
                  document.getElementById('HoraID').innerHTML = Vehiculos[pos].Hora;
                  document.getElementById('RPMID').innerHTML = Vehiculos[pos].RPM;

                }

                var valor = document.getElementById('switch').checked;

                if (valor){
                  if (!poly_created){
                    startPolyline(selected_value);
                  }else{
                    updatePolyline(selected_value);
                  }
                } else{
                  if (poly_created){
                    clearPolylines();
                  }
                }
            }
        });

        //Este socket detecta si no hay ningún usuario conectado en el mapa.
        io().on('nousersconnected', function(){
            clearMarkers(); clearPolylines();
            var label= document.getElementById('label_recorrido');
            var sw= document.getElementById('layer_switch');
            var lista_select = document.getElementById("IDtxtID");
            var number_users = document.getElementById("usersnumber");
          
            if (lista_select.length>1){
              let loops=lista_select.length;
              for (var i=0; i<loops; i++) {
                lista_select.remove(1);      
              }
            }
            document.getElementById('switch').checked=false;
            label.style.visibility="hidden"; sw.style.visibility="hidden";

            document.getElementById('UsuID').innerHTML = '-';
            document.getElementById('LatID').innerHTML = '-';
            document.getElementById('LongID').innerHTML = '-';
            document.getElementById('FechaID').innerHTML = '-';
            document.getElementById('HoraID').innerHTML = '-';
            document.getElementById('RPMID').innerHTML = '-';

            number_users.innerHTML = '0';
            number_users.style.color='rgb(214, 0, 71)';
            console.log('NO HAY USUARIOS CONECTADOS! ADONDEFUERON?');
        });
    });

  </script>
</body>

</html>