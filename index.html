<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LocateCabs</title>
  <style>
    div {
      margin-bottom: 10px;
      text-align: center;
    }

    label {
      font-family: Arial;
      font-style: normal;
      font-size: 120%;
      display: inline-block;
      width: 150px;
      text-align: center;
    }

    input {
      font-size: 120%;
    }

    header {
      /*color: rgb(76, 175, 80);*/
      font-family: Arial;
      font-style: normal;
      font-size: 300%;
      text-align: left;
      margin-bottom: 50px;
    }

    #mapid {
      height: 750px; width:950px;  float: left
    }

    button {
      background-color: rgb(184, 194, 42);
      border: none;
      color: white;
      padding: 12px 29px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 100%;
    }

    button:hover {

      background-color: rgb(184, 194, 42);
    }

    button:active {

      background-color: rgb(155, 163, 44);
      /* box-shadow: 0 5px #666; */
      transform: translateY(4px);

    }

    .sw {
      display: inline-block;
      width: 100px;
      height: 35px;
      background: darkgray;
      border-radius: 100px;
      cursor: pointer;
      position: relative;
      transition: .2s;



    }

    .sw::after {
      content: "";
      display: block;
      width: 25px;
      height: 25px;
      background-color: snow;
      border-radius: 100px;
      position: absolute;
      top: 5px;
      left: 4px;
      transition: .2s;



    }

    #switch:checked+.sw::after {
      left: 70px;
    }

    #switch:checked+.sw {
      left: 0px;
      background-color: rgb(184, 194, 42);
    }

    #switch {
      display: none;
    }
    
    #switch2:checked+.sw::after {
      left: 70px;
    }

    #switch2:checked+.sw {
      left: 0px;
      background-color: rgb(184, 194, 42);
    }

    #switch2 {
      display: none;
      content: "Trazar";
      position: relative;
    }
    
    .divSquare{
        width:200; padding: 5px 50px 0px 5px;
    }
    .CenterButton{
        width:200; padding: 5px 50px 5px 5px;
    }
    .HistoricButton{
        width:200; padding: 5px 20px 5px 5px;
    }
    
    
    #CenterBS {
      padding: 5px 5px 5px 5px;     
      display: inline-block;
    }
    
    #B2 {
      margin-right: 10px;
      display: inline;
    }
    
    #S2 {
      display: inline;
    }
        
    input:checked:not([disabled]){   
      background-color: #2196F3; 
    }

  </style>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin=""></script>
</head>

<body style="background-color:white;">
  <div>
    <header style="text-align: center"><b><i>LocateCabs</b></i></header>
  </div>
  <div id="mapid"></div>

  <div class="divSquare">
      <h1>Información de Geolocalización</h1>
  </div>

  <div class="divSquare">
    <label>Usuario</label>
    <label id="UsuID" style="border: 1px solid black; border-radius: 8px; width: 300px;">-</label>
  </div>
  <div class="divSquare">
    <label>Latitud</label>
    <label id="LatID" style="border: 1px solid black; border-radius: 8px; width: 300px;">-</label>
  </div>
  <div class="divSquare">
    <label>Longitud</label>
    <label id="LongID" style="border: 1px solid black; border-radius: 8px; width: 300px;">-</label>
  </div>
  <div class="divSquare">
    <label>Fecha</label>
    <label id="FechaID" style="border: 1px solid black; border-radius: 8px; width: 300px;">-</label>
  </div>
  <div class="divSquare">
    <label>Hora</label>
    <label id="HoraID" style="border: 1px solid black; border-radius: 8px; width: 300px;">-</label>
  </div>
  <div class="CenterButton;">
    <button onclick="MapAutoCenter(), Markerlabel()" style="border: 1px solid black; border-radius: 8px; width: 250px;">Auto-center Camera</button>
  </div>

  <center>
    <h3>Polilinea en vivo</h3>
  </center>

  <div class="switch-container;">
    <input type="Checkbox" id="switch">
    <label for="switch" onclick="condicional();" class="sw"></label>
  </div>

  <center>
    <h3>Consulta de Historicos</h3>
  </center>

  <div class="divSquare">
        <label for="IHist">Inicio:</label>
        <input type="datetime-local" id="IHist" oninput="changehist()" name="InitialHistoric" value="2021-06-01T00:00" min="2021-06-01T00:00" max="2044-06-01T00:00">
        <div></div>
        <label for="FHist">Fin:</label>
        <input type="datetime-local" id="FHist" oninput="changehist()" name="FinalHistoric" value="2021-06-02T00:00" min="2021-06-01T00:00" max="2044-06-01T00:00">

  </div>

  <center>

  <div class="divSquare">

    <label for="iname">Usuario</label>
    <input type="text" id="iname" onchange="changehist()" name="Usuario" style="border: 1px solid black; border-radius: 8px; width: 200px;"/>
  </center>

  </div>

  <center>
      <h3>Trazar Históricos</h3>

      <div id= "S2" class="switch-container;">
        <input type="Checkbox" id="switch2">
        <label for="switch2" onclick="condicional2();" class="sw"></label>
      </div>
    </div>

  </center>

  
  <script src="/socket.io/socket.io.js"></script>


  <script>

    let lat = 10.984719;
    let long = -74.811302;
    var polylinePoints;
    var polyline;
    var datausua;
    var datainicio;
    var datafin;
    var polylineHistoric;
    var polyline_set=0;
    var startpoint;
    var startpointHist;
    var finalpointHist;
    var startpoint_was_set=0;
    var hist_was_set=0;
    let latlngs = [];
    let latlngsTemp = [];
    let Coordinates = [];

   
    function changehist(){
      valor = document.getElementById('switch2').checked;
      if (valor) {
        enviarhist();

        setTimeout(function(){
            if (Coordinates.length!=0){
              if (hist_was_set==1){
                  polylineHistoric.setLatLngs(Coordinates);
                  startpointHist.setLatLng(Coordinates[0]);
                  finalpointHist.setLatLng(Coordinates[Coordinates.length-1]);
                  mymap.fitBounds(Coordinates);
                
              } else {
                startPolyline2();
                startpointHist= L.marker(Coordinates[0]).addTo(mymap);
                finalpointHist= L.circleMarker(Coordinates[Coordinates.length-1],{ color: '#FFB242' }).addTo(mymap);

              }
            } else {

              console.log('El intervalo de tiempo o Usuario ingresado no es válido.');

            }
        }, 1000)

      }
    }
    
    async function enviarhist()  {
        datausua = document.getElementById('iname').value;
        datainicio = document.getElementById('IHist').value ;
        datafin = document.getElementById('FHist').value;
        datainicio = new Date(datainicio).valueOf();
        datafin = new Date(datafin).valueOf() ;
        datainicio = datainicio.toString() ; 
        datafin = datafin.toString() ; 
        console.log('datausua= '+datausua);
        console.log('datainicio= '+datainicio); 
        console.log('datafina= '+datafin);   
        
        const info = {datausua, datainicio, datafin};
        const options = {

          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },


          body: JSON.stringify(info)
        };
        
        await fetch('/historic', options);

      }
    
   
    function MapsetUbication() { 
      mymap.setView(new L.LatLng(lat, long)); 
    }

    function MapAutoCenter() { 
      if (document.getElementById('switch').checked){
        console.log(polyline.getBounds())
        mymap.fitBounds(polyline.getBounds()); //Centra hacia la polilínea.
      } else {
        mymap.setView(new L.LatLng(lat, long), 18);  //Centra hacia la posición actual.
      }   
    }

    function setMarker() {
      if(lat!=null && isNaN(lat)==false && long!=null && isNaN(long)==false){
        circle_marker.setLatLng(new L.LatLng(lat, long));
        circle.setLatLng(new L.LatLng(lat, long));
      }
    }

    function Markerlabel() {
      circle_marker.bindPopup(usuario, { autoPan: false }).openPopup()
    }

    function createStartPoint() { 
      startpoint= L.marker([lat,long]).addTo(mymap);
    }

    function startPolyline() {
      if (isNaN(latlngs)==false){
        polyline = L.polyline(latlngs).addTo(mymap); 
        polyline_set=1;
      }
    }

    function startPolyline2() {
      if (Coordinates.length!=0){
        polylineHistoric = L.polyline(Coordinates, {color: 'red'}).addTo(mymap);
        mymap.fitBounds(Coordinates);
        hist_was_set=1;
      } else {

        console.log('El intervalo de tiempo o Usuario ingresado no es válido.');

      }
    }

    function addPolyline() {
      if ((polyline_set==1)){
        polyline.setLatLngs(latlngs) 
        if (!polyline.isEmpty() && polyline.getLatLngs().length==1 && startpoint_was_set==0){
          setTimeout(createStartPoint(), 1000)
          startpoint_was_set=1;
        }    
      }
    }

    function clearpoly() {
      if (polyline_set==1){
        polyline.removeFrom(mymap)
      }
    }
    function clearpoly2() {
        polylineHistoric.removeFrom(mymap)
        hist_was_set=0;

    }

    let mymap = L.map('mapid').setView([lat, long], 18);
    var circle = L.circle([lat, long], { radius: 50, color: '#FCFF42' }).addTo(mymap);
    var circle_marker = L.circleMarker([lat, long], { color: '#CA2049' }).bindPopup("No Data", { autoPan: false }).addTo(mymap);
    circle_marker.openPopup();


    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(mymap);



    document.addEventListener('DOMContentLoaded', function () {
      old_user = "-";
 
      io().on('change', function (data) {
     
        document.getElementById('UsuID').innerHTML = data.DataUsu;
        document.getElementById('LatID').innerHTML = data.DataLat;
        document.getElementById('LongID').innerHTML = data.DataLong;

        var date = new Date(parseFloat(data.DataTime));
        var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        var month = months[date.getMonth()];
        var hours = date.toLocaleTimeString();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = hours.substr(0,2) +':'+ minutes.substr(-2) + ':' + seconds.substr(-2);

        var datofecha =  date.getDate()+"/"+  month+"/"+date.getFullYear() ;

        document.getElementById('FechaID').innerHTML = datofecha;
        document.getElementById('HoraID').innerHTML = formattedTime;
        lat = data.DataLat;
        long = data.DataLong;


        usuario = data.DataUsu;
        finallong = data.DataLong;
        finallat = data.DataLat;

        setInterval(setMarker, 1000);

        valor = document.getElementById('switch').checked;
        if (valor) {
          
          setInterval(latlngsTemp = [lat, long], 1000);
          setInterval(latlngs.push(latlngsTemp), 1000);
        } else {
          latlngs = [];
        }


        if (old_user != usuario) {
          setTimeout(function () {
            MapsetUbication();
            Markerlabel();
            if (valor) {
              latlngs = [];
              if (startpoint_was_set==1){
                startpoint.removeFrom(mymap);
                startpoint_was_set=0;
              }
              clearpoly();
              startPolyline();
            }
          }
            , 1000);

          old_user = usuario;
        }


      });


    });

    function condicional() {
      if (document.getElementById('switch').disabled != true){
        valor = document.getElementById('switch').checked;

        if (valor) {

          setTimeout(function(){
            clearpoly();
            circle.setRadius(50);
            circle_marker.openPopup();
            if (startpoint_was_set==1){
              startpoint.removeFrom(mymap);
              startpoint_was_set=0;
            }
          }
            , 100)
            document.getElementById('switch2').disabled = false;
        }

        else {
          console.log('latlngs='+ latlngs.length)
          document.getElementById('switch2').disabled = true;
          setTimeout(function(){
            circle.setRadius(0);
            startPolyline();
          }
            , 1000);
          
          setInterval(function () {
            setMarker();
            addPolyline();
          }
            , 1000);

        }
      }
    }

    io().on('timestamp', function (dataTS) {
        Coordinates = dataTS.DataTimeStamp;
        console.log('io-on-timestamp Coordinates= '+Coordinates)
      });
    
    function condicional2() {
      if (document.getElementById('switch2').disabled != true){
        valor = document.getElementById('switch2').checked; 
        if (valor) {
          if (hist_was_set==1){
            clearpoly2();
            startpointHist.removeFrom(mymap);
            finalpointHist.removeFrom(mymap);
          }
          setMarker();
          circle_marker.setRadius(10);
          circle.setRadius(50);
          circle_marker.openPopup();
          document.getElementById('switch').disabled = false;
        }else{
          document.getElementById('switch').disabled = true;
          enviarhist();
          setTimeout(function(){
            startPolyline2();
            if (Coordinates.length!=0){
              startpointHist= L.marker(Coordinates[0]).addTo(mymap);
              finalpointHist= L.circleMarker(Coordinates[Coordinates.length-1],{ color: '#FFB242' }).addTo(mymap);
            }
            circle_marker.closePopup();
            circle_marker.setRadius(0);
            circle.setRadius(0);
          },500)

        }
      }
    }
  </script>

</body>

</html>