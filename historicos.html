<!DOCTYPE html>

<html lang="en" dir="ltr">

<head>
  <meta charset="utf-8">
  <title>LocateCabs Históricos</title>
  <link rel="icon" href="/favicon.ico"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
    crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
    integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
    crossorigin="">
    </script>
</head>
<style>
  *{
    padding: 0;
    margin: 0;
    text-decoration: none;
    list-style: none;
    box-sizing: border-box;
  }
  h1:hover{
    cursor: default;
  }
  h2:hover{
    cursor: default;
  }
  body{
    font-family: sans-serif;
    background-image: url('/bg.png');
    height: 100%;
    margin: 0;
    padding: 0;
  }
  label {
    margin:5px;
    font-size: 120%;
    display: inline-block;
  }
  button {
    background-color: #F4D03F;
    border: none;
    color: black;
    padding: 12px 29px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 100%;
  }
  button:hover {
    background-color: #F4D03F;
  }
  button:active {
    background-color: #F4D03F;
    /* box-shadow: 0 5px #666; */
    transform: translateY(4px);
  }
  nav{
    background: rgba(255, 212, 20, 0.8);
    height: 80px;
    width: 100%;
  }
  .padre{
    position: relative;
  }
  .cabecera{
    position: relative;
    z-index: 2;
  }
  .logo{
    display: inline-block;
    margin-top: 2px;
    padding: 0 40px;
  }
  #logoimg{
      height: 70px;
      width: 380px;
  }
  nav ul{
    float: right;
    margin-right: 20px;
  }
  nav ul li{
    display: inline-block;
    line-height: 80px;
  }
  nav ul li a{
    color: rgb(17, 17, 17);
    font-size: 17px;
    font-weight: bold;
    padding: 30px 13px; 
    text-transform: uppercase;
  }
  a.menulink.active,a.menulink:hover{
    background: rgb(19, 19, 19);
    color: rgb(255, 255, 255); 
    transition: .2s;
    border-bottom:4px solid rgb(0, 130, 230);
  }
  .checkbtn{
    font-size: 30px;
    color: rgb(15, 15, 15);
    float: left;
    line-height: 80px;
    margin-left: 15px;
    cursor: pointer;
    display: none;
  }
  #check{
    display: none;
  }
  #mapid {
    margin: 5px;
    height: 650px;
    width: 60%;
    float: left;
    border: 5px solid rgb(12, 12, 12);
    border-radius: 15px;
  }
  #container {
    background-color: rgba(255, 212, 20, .8);
    margin: 1px;
    height: auto;
    width: auto;
    border: 5px solid rgba(12, 12, 12, .8);
    border-radius: 15px;
    overflow: hidden;
  }
  .inlineclass {
    display: inline-block;
  }
  .CenterButton {
    width: 200;
    padding: 5px 50px 5px 5px;
  }
  .sw {
    display: inline-block;
    width: 100px;
    height: 35px;
    background: rgb(19, 19, 19);
    border-radius: 100px;
    cursor: pointer;
    position: relative;
    transition: .5s;
  }
  .sw::after {
    content: "";
    display: block;
    width: 25px;
    height: 25px;
    background-color: snow;
    border-radius: 100px;
    position: absolute;
    top: 5px;
    left: 4px;
    transition: .5s;
  }
  #switch2:checked+.sw::after {
    left: 70px;
  }
  #switch2:checked+.sw {
    left: 0px;
    background-color: rgb(184, 194, 42);
  }
  #switch2 {
    display: none;
  }

  .wrapper {
    display: flex;
    width: 100%;
    align-items: center;
    justify-content: center;
    float: center;
    margin-top: 5%;
    position: relative;
    z-index: 1;
  }
  @media (max-width: 860px){
    .logo{
      margin-top: 20px;
      padding-left: 5px;
    }
    #logoimg{
      height: 50px;
      width: 210px;
    }
    .wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      text-align: center;
    }
    #mapid {
      height: 300px;
      width: 90%;
      border-radius: 15px;

    }
    #container {
      height: auto;
      width: 90%;
      
    }
    .checkbtn{
      display: block;
    }
    ul{
      position: absolute;
      width: 65%;
      height: auto;
      background: rgba(58, 58, 58, 0.9);
      top: 80px;
      left: -100%;
      text-align: center;
      transition: all .5s;
    }
    nav ul li{
      display: block;
      margin: 65px 0;
      line-height: 30px;
    }
    nav ul li a{
      font-size: 20px;
    }
    a.menulink:hover,a.menulink.active{
      background: none;
      color: rgb(0, 130, 230);
    }
    #check:checked ~ ul{
      left: 0;
    }
  }
  @media (max-width: 300px){
    #logoimg{
      height: 50px;
      width: 20vh;

    }

  }
  @media (max-width: 267px){
    #logoimg{
      display: none;

    }
    
  }
  section{
    background: url(bg1.jpg) no-repeat;
    background-size: cover;
    height: calc(100vh - 80px);
  }

  footer{
    position: relative;
    background:rgba(17, 17, 17, 0.9);
    height: auto;
    width: 100%;
    bottom: 0px;
    font-family: "Open Sans";
    color:rgb(255, 255, 255);
    z-index: 1;
  }
  .footer-content{
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    text-align: center;
  }
  .footer-content h3{
    font-size: 1.8rem;
    font-weight: 400;
    text-transform: capitalize;
    line-height: 3rem;
  }
  .footer-content p{
    margin: 2px auto;
    line-height: 28px;
    font-size: 14px;
  }
  .footer-bottom{
    background: rgba(17, 17, 17, 0.96);
    width: 100%;
    padding: 5px 0;
    text-align: center;
  }
  .footer-bottom span{
    color:rgba(255, 212, 20);
    text-transform: uppercase;
    font-weight: 200;
  }

  .slider {
    -webkit-appearance: none;
    width: auto;
    height: 15px;
    border-radius: 5px;  
    background: #181818;
    outline: none;
    opacity: 0.7;
    -webkit-transition: .2s;
    transition: opacity .2s;
  }

  .slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 25px;
    height: 25px;
    border-radius: 50%; 
    background: rgb(255, 255, 255);
    cursor: pointer;
  }

  .slider::-moz-range-thumb {
    width: 25px;
    height: 25px;
    border-radius: 50%;
    background: rgb(255, 255, 255);
    cursor: pointer;
  }

</style>
<body>
  <div class="padre">
    <div class="cabecera">
      <nav>
        <input type="checkbox" id="check">
        <label for="check" class="checkbtn">
          <i class="fas fa-bars"></i>
        </label>
        <a href="/" class="logo"><img src="/logo.png" id="logoimg" /></a>
        <ul>
          <li><a class="menulink" href="../">Home</a></li>
          <li><a class="menulink"  style="background: rgb(19, 19, 19); color: rgb(255, 255, 255); border-bottom:4px solid rgb(0, 130, 230);">Históricos</a></li>
        </ul>
      </nav>
    </div>
    <div class="wrapper">
      <div class="inlineclass" id="mapid"></div>
      <div class="inlineclass" style="text-align: center;" id="container">
        <h2 style="text-align: center; margin-top: 15px;">Consultar historial del trayecto</h2>
        <div></div>
        <label class="inlineclass" style="width: 140px; padding-left: 10px;" for="IHist">Inicio:</label>
        <input class="inlineclass" style="text-align: center;" type="datetime-local" id="IHist" onchange="changehist()" name="InitialHistoric" value="2021-06-01T00:00"
          min="2021-06-01T00:00" max="2044-06-01T00:00">
        <div></div>
        <label class="inlineclass" style="width: 140px; padding-left: 10px;" for="FHist">Fin:</label>
        <input class="inlineclass" style="text-align: center;" type="datetime-local" id="FHist" onchange="changehist()" name="FinalHistoric" value="2021-06-02T00:00"
          min="2021-06-01T00:00" max="2044-06-01T00:00">
        <div></div>
        <label class="inlineclass" style="width: 140px;" for="vehiculo">ID del vehículo:</label>
        <select name="cars" id="vehiculo" onchange="changehist()" style="margin-top: 10px; text-align: center; border-radius: 8px; font-size: 100%;">
          <option value="none">Seleccionar ID</option>
        </select>

        <div></div>
        <div class="switch-container;" style="text-align: center; margin-top: 5px;">
          <input type="Checkbox" id="switch2">
          <label for="switch2" onclick="condicional_switch_historico(); " class="sw"></label>
        </div>
        <div></div>
        
        <h2 style="text-align: center; margin-top: 15px; visibility:hidden;" id="title_poly">Recorrer Polilínea</h2> 
        <div></div>

        <div class="slidecontainer">
          <h4 style="text-align: center; visibility:hidden;" id="guia_recorrido" >Inicio - Fin</h4>
          <input type="range" min="0" max="100" value="0" class="slider" id="myRange" onchange="imprimirValor();" style=" margin-top: 15px; margin-bottom: 15px; visibility:hidden;">
        </div>
      </div>
    </div>
    
    <footer>
      <div class="footer-content">
        <h3>LocateCABS</h3>
        <p>Repositorio</p>
        <li><a href="https://github.com/danielgonzale5/LocateCabs" target="_blank"><img src="/github.svg" id="gitimg" style="width: 45px;"/></a></li>
        <div class="footer-bottom">
          <p style="font-weight: bold; text-shadow: 2px 2px 8px #ffffff;">Copyright &copy;2021-2022 LocateCABS. designed by: <span>DanielG LeonardoC BozidarY JuanM & JorgeR</span></p>
        </div>
      </div>
    </footer>
  </div>


  <script src="/socket.io/socket.io.js"></script>
  <script>

    //-----------Declaración de Variables Globales
    let lat = 10.984719;
    let long = -74.811302;
    var datainicio;
    var datafin;
    var polylineHistoric;
    var hist_was_set = 0;
    var startpointHist;
    var finalpointHist;
    let User = [];
    let Coordinates = [];
    var switch_turned_on=false;
    var historic_updated=false;
    var popuphistorico;
    let tiempo=[];
    let tiempotran=[];

    //Este objeto es el ícono verde que se observa en el mapa. Es personalizado, por tanto se importa desde una URL externa.
    var greenIcon = new L.Icon({
    iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
    });


    //------------------Zona de funciones

    //Esta función imprime el valor de la posición de la polilínea del histórico en consola y genera el Popup en pantalla por cada vez que se desliza en el Slider.
    function imprimirValor(){
      var title=document.getElementById('title_poly');
      var slider= document.getElementById('myRange');
      slide_valor= slider.value;
      console.log("Moviéndose a la posición ("+ slide_valor + ") del vector de polilínea generado");
      latlng = polylineHistoric.getLatLngs()[slide_valor];
      let info = tiempotran[slide_valor].toString() + " Ubicación: " + latlng.toString();
      popuphistorico = L.popup().setLatLng(latlng).setContent(info).openOn(mymap);
    };

    //Función que regula el valor de los calendarios de tal modo que el final se encuentre siempre igual o después del inicial.
    window.addEventListener('load', function () {
      datainicio = document.getElementById('IHist')
      datainicio.addEventListener('change', function () { 
        if (document.getElementById('FHist').value < this.value) { 
        document.getElementById('FHist').value = this.value;
        }

      });
      datafin = document.getElementById('FHist')
      datafin.addEventListener('change', function () {
        if (document.getElementById('IHist').value > this.value) {
          this.value = document.getElementById('IHist').value;
        }
      });

    });

    //Función para cambiar el histórico si se cambian los valores de calendario o ID del vehículo.
    function changehist() {
      valor = document.getElementById('switch2').checked;
      var select = document.getElementById('vehiculo');
      var user_value = select.options[select.selectedIndex].value;

      if (valor && user_value!='none') {
          historic_updated=true;
          console.log('Se seleccionó el vehículo con la ID: '+ user_value);
          enviarhist(user_value);
          
      }
    }

    //Función de conexión Frontend-Backend del histórico
    async function enviarhist(user_id) {
      datainicio = document.getElementById('IHist').value;
      datafin = document.getElementById('FHist').value;
      datainicio = new Date(datainicio).valueOf();
      datafin = new Date(datafin).valueOf();
      datainicio = datainicio.toString();
      datafin = datafin.toString();
      datauser = user_id.toString();
      console.log('datainicio= ' + datainicio);
      console.log('datafin= ' + datafin);
      console.log('datauser= ' + datauser);

      const info = { datainicio, datafin, datauser };
      const options = {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(info)
      };
      await fetch('/historic', options);
    }

    //Esta función inicia el objeto de polilínea del histórico cuando se activa el switch o sea cambia el calendario/ID del vehículo siempre y cuando no se haya creado un objeto antes.
    function startPolyHist() {
      polylineHistoric = L.polyline(Coordinates, { color: 'red' }).addTo(mymap);
      mymap.fitBounds(Coordinates)
    }

    //Esta función limpia la polilínea que representa el histórico.
    function clearPolyHist() {
      polylineHistoric.removeFrom(mymap)
      hist_was_set = 0;
    }



    //-------------Zona de objetos, condicionales y ciclos para generar la lógica principal del documento.

    //Aquí se crea el objeto asignado para el mapa llamado "mymap".
    let mymap = L.map('mapid').setView([lat, long], 18);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(mymap);

    //Este socket recibe el vector de usuarios de la base de datos vistos por primera vez cuando se conecta el cliente a la página.
    io().on('init_users', function (users){
      Userv= users.Usersvec;
      console.log(Userv);

      var lista_select = document.getElementById('vehiculo');

      for (var i = 0; i<Userv.length; i++){
        if (Userv[i]!='' && Userv[i]!='-'){
          var new_opt = document.createElement('option');
          new_opt.value = Userv[i];
          new_opt.innerHTML = Userv[i];
          lista_select.appendChild(new_opt);
        }
      } 
    });

    //Este socket, a diferencia del anterior, detecta si hay un usuario nuevo en la base de datos y lo agrega a la lista desplegable. Esto es para que el cliente no se vea obligado a recargar la página.
    io().on('new_user_detected', function(user){

      usuario_detectado=user.Newuser;
      var lista_select = document.getElementById('vehiculo');
      var new_opt = document.createElement('option');
      new_opt.value = usuario_detectado;
      new_opt.innerHTML = usuario_detectado;
      lista_select.appendChild(new_opt);

    })


    //Este es el socket donde se reciben los vectores correspondientes a Usuario, Coordenadas y Tiempo desde el evento "timestamp" emitido por el Backend.
    //Aquí se llaman casi todas las funciones importantes que generan las polilíneas para que sea un proceso sincrónico.
    io().on('timestamp', function (dataTS) {
      User = dataTS.DataUsuario;
      Coordinates = dataTS.DataTimeStamp;
      tiempo = dataTS.DatoTiempo;
      console.log('io-on-timestamp Coordinates= ' + Coordinates)

      for (var j = 0; j < dataTS.DatoTiempo.length; j++) {
        var date = new Date(parseFloat(tiempo[j]));
        var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        var month = months[date.getMonth()];
        var hours = date.toLocaleTimeString();
        var minutes = "0" + date.getMinutes();
        var seconds = "0" + date.getSeconds();
        var formattedTime = 'Tiempo: '+hours.substr(0, 2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2)+' Fecha: '+date.getDate() + "/" + month + "/" + date.getFullYear();
        tiempotran.push(formattedTime);
      }


      if (switch_turned_on){

        if (Coordinates.length != 0 && hist_was_set==0) {
              var title=document.getElementById('title_poly');
              var slider= document.getElementById('myRange');
              var guia= document.getElementById('guia_recorrido');
              startPolyHist();
              startpointHist = L.marker(Coordinates[0], {icon: greenIcon }).addTo(mymap);
              finalpointHist = L.marker(Coordinates[Coordinates.length - 1]).addTo(mymap);
              finalpointHist.bindPopup("Fin", { autoPan: false }).openPopup()
              startpointHist.bindPopup("Inicio", { autoPan: false }).openPopup()
              slider.min=0; slider.max=polylineHistoric.getLatLngs().length-1;
              guia.style.visibility="visible"; title.style.visibility="visible"; slider.style.visibility="visible";
              polylineHistoric.on('click',(e)=>{

                for (var i = 0; i < tiempo.length; i++) {
                  var errorlat = Math.abs((Math.abs(parseFloat(Coordinates[i][0])) - Math.abs(parseFloat(e.latlng.lat)) ))/ Math.abs(parseFloat(Coordinates[i][0])); 
                  var errorlot = Math.abs((Math.abs(parseFloat(Coordinates[i][1])) - Math.abs(parseFloat(e.latlng.lng)) ))/ Math.abs(parseFloat(Coordinates[i][1])); 
                  if((errorlat<0.000003)&&(errorlot<0.000003)){
                    break; 
                  }

                  if (tiempo.length==i+1) {
                    break; 
                  }

                }

                let info =  tiempotran[i].toString()+" Ubicación: " + e.latlng.toString();
                L.popup().setLatLng(e.latlng).setContent(info).openOn(mymap);
              })
              hist_was_set=1;
        }
        if (Coordinates.length==0 && hist_was_set==0){
                console.log('El intervalo de tiempo ingresado no es válido.');
        } 
              
        switch_turned_on=false;

      } else{

        if (historic_updated){
          var title=document.getElementById('title_poly');
          var slider= document.getElementById('myRange');
          var guia= document.getElementById('guia_recorrido');
          if (hist_was_set==0){
            if (Coordinates.length != 0){

              setTimeout(function () {           
                    startPolyHist();
                    startpointHist = L.marker(Coordinates[0], {icon: greenIcon }).addTo(mymap);
                    finalpointHist = L.marker(Coordinates[Coordinates.length - 1]).addTo(mymap);
                    finalpointHist.bindPopup("Fin", { autoPan: false }).openPopup()
                    startpointHist.bindPopup("Inicio", { autoPan: false }).openPopup()
                    slider.min=0; slider.max=polylineHistoric.getLatLngs().length-1;
                    guia.style.visibility="visible"; title.style.visibility="visible"; slider.style.visibility="visible";
                    polylineHistoric.on('click',(e)=>{
                      
                      for (var i = 0; i < tiempo.length; i++) {
                        var errorlat = Math.abs((Math.abs(parseFloat(Coordinates[i][0])) - Math.abs(parseFloat(e.latlng.lat)) ))/ Math.abs(parseFloat(Coordinates[i][0])); 
                        var errorlot = Math.abs((Math.abs(parseFloat(Coordinates[i][1])) - Math.abs(parseFloat(e.latlng.lng)) ))/ Math.abs(parseFloat(Coordinates[i][1])); 
                        if((errorlat<0.000003)&&(errorlot<0.000003)){
                          break; 
                        }

                        if (tiempo.length==i+1) {
                          break; 
                        }

                      }

                      let info =  tiempotran[i].toString()+" Ubicación: " + e.latlng.toString();
                      L.popup().setLatLng(e.latlng).setContent(info).openOn(mymap);

                    })

                    hist_was_set=1;

                }, 300)

                mymap.fitBounds(Coordinates);
            } else {

              console.log('El intervalo de tiempo ingresado no es válido.');

            }
            


          } else {
            if (Coordinates.length != 0){
              setTimeout(function () { 
                polylineHistoric.setLatLngs(Coordinates);
                startpointHist.setLatLng(Coordinates[0]);
                finalpointHist.setLatLng(Coordinates[Coordinates.length - 1]);
                mymap.fitBounds(Coordinates);
                mymap.closePopup();
                slider.min=0; slider.max=polylineHistoric.getLatLngs().length-1;
                polylineHistoric.on('click',(e)=>{

                  for (var i = 0; i < tiempo.length; i++) {
                    var errorlat = Math.abs((Math.abs(parseFloat(Coordinates[i][0])) - Math.abs(parseFloat(e.latlng.lat)) ))/ Math.abs(parseFloat(Coordinates[i][0])); 
                    var errorlot = Math.abs((Math.abs(parseFloat(Coordinates[i][1])) - Math.abs(parseFloat(e.latlng.lng)) ))/ Math.abs(parseFloat(Coordinates[i][1])); 
                    if((errorlat<0.000003)&&(errorlot<0.000003)){
                      break; 
                    }

                    if (tiempo.length==i+1) {
                      break; 
                    }

                  }

                  let info =  tiempotran[i].toString()+" Ubicación: " + e.latlng.toString();
                  L.popup().setLatLng(e.latlng).setContent(info).openOn(mymap);
                })
              }, 300)

            }else{

              console.log('El intervalo de tiempo nuevo no es válido.');

            }
          }

          historic_updated=false;


        }

      }


    });
   
    //Función que define la acción a realizar cuando se activa o desactiva el switch de histórico. (Su callback se da por presionar click en el switch)
    function condicional_switch_historico() {
        var valor = document.getElementById('switch2').checked;
        var guia= document.getElementById('guia_recorrido');
        var title=document.getElementById('title_poly');
        var slider= document.getElementById('myRange');
        var select = document.getElementById('vehiculo');
        var user_value = select.options[select.selectedIndex].value;

        if (valor) {
          if (hist_was_set == 1) {

            guia.style.visibility="hidden"; title.style.visibility="hidden"; slider.style.visibility="hidden";
            clearPolyHist();
            startpointHist.removeFrom(mymap);
            finalpointHist.removeFrom(mymap);
            mymap.closePopup();
          }
        } else {
          if(user_value!='none'){
            switch_turned_on=true;
            console.log('Se seleccionó el vehículo con la ID: '+ user_value);
            enviarhist(user_value);
 
          }

        }
    }

  </script>
</body>

</html>